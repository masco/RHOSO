---
- name: clean up the dt_path
  file:
    path: "{{ dt_path }}"
    state: absent

- name: clone architecture repo
  git:
    repo: https://github.com/masco/architecture.git
    dest: "{{ dt_path }}"
    version: bm-ocp
    force: yes

- name: download kustomize lib
  shell:
    curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash

- name: move the kustomize to usr-bin
  shell:
    mv kustomize /usr/bin/.

- name: download ocp_inventry file(scale)
  uri:
    url: "https://wiki.scalelab.redhat.com/instack/{{ cloud }}_ocpinventory.json"
    return_content: true
  register: ocpinventory_scale
  when: lab == 'scalelab'

- name: download ocp_inventry file(alias)
  uri:
    url: "https://wiki.rdu3.labs.perfscale.redhat.com/instack/{{ cloud }}_ocpinventory.json"
    return_content: true
  register: ocpinventory_alias
  when: lab == 'performancelab'

- name: set fact ocp inventory
  set_fact:
    ocp_inventry: "{{ ocpinventory_scale if lab == 'scalelab' else ocpinventory_alias }}"

# Ceph dynamic inventory block
- block:
  - name: parse nodes from ocp inventory
    set_fact:
      all_nodes: "{{ (ocp_inventry.content | from_json).nodes }}"
      total_num_nodes: "{{ (ocp_inventry.content | from_json).nodes | length }}"

  - name: validate sufficient nodes for deployment
    fail:
      msg: "Insufficient number of nodes available for ceph cluster"
    when: (total_num_nodes | int) - 4 - (ceph_node_count | int) <= 0

  - name: select nodes for ceph from bottom of list
    set_fact:
      storage_nodes: "{{ all_nodes[-ceph_node_count:] }}"
      storage_admin_node: "{{ all_nodes[-ceph_node_count] }}"

  - name: add storage admin node to dynamic inventory
    add_host:
      name: "{{ storage_admin_node.name }}"
      groups: admin
      ansible_host: "{{ storage_admin_node.name }}"
      ansible_user: root
      ansible_ssh_password: "{{ ansible_ssh_password }}"
      ansible_become: yes
      ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

  - name: add all storage nodes to ceph_nodes group in dynamic inventory
    add_host:
      name: "{{ item.name }}"
      groups: ceph_nodes
      ansible_host: "{{ item.name }}"
      ansible_user: root
      ansible_ssh_password: "{{ ansible_ssh_password }}"
      ansible_become: yes
      ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    loop: "{{ storage_nodes }}"

  when: ceph_enabled | bool

- name: enable ip forward for ovn-kubernets
  shell: |
    oc patch network.operator cluster -p '{"spec":{"defaultNetwork": {"ovnKubernetesConfig":{"gatewayConfig":{"ipForwarding": "Global"}}}}}' --type=merge